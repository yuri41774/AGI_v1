<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Administrador - Igreja Conectada</title>
    <link rel="stylesheet" href="css/global.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/supabaseClient.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #1c1e21;
            line-height: 1.4;
        }
        * { box-sizing: border-box; }
        a { text-decoration: none; color: #1877f2; }
        a:hover { text-decoration: underline; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; }

        .admin-header {
            background-color: #1877f2; 
            color: white;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
        }
        .admin-header .logo-area a {
            color: white;
            text-decoration: none;
            font-size: 1.4em;
            font-weight: 600;
        }
        .admin-header .user-actions a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
        }
        .admin-header .user-actions svg {
            vertical-align: middle;
            margin-right: 4px;
            width: 18px;
            height: 18px;
            fill: white;
        }

        .admin-body-container {
            display: flex;
            min-height: calc(100vh - 50px); /* Altura do header ~50px */
        }

        .admin-sidebar {
            width: 250px; 
            background-color: #fff; 
            box-shadow: 1px 0 3px rgba(0,0,0,0.05);
            padding: 15px 0;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 50px; 
            height: calc(100vh - 50px);
            overflow-y: auto;
        }
        .admin-sidebar .sidebar-header {
            padding: 10px 20px;
            margin-bottom:10px;
            text-align: center;
        }
        .admin-sidebar .sidebar-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 8px;
            background-color: #ccc; /* Placeholder */
            background-size: cover;
            background-position: center;
        }
        .admin-sidebar .sidebar-header h3 {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
        }
        .admin-sidebar .sidebar-header p {
            margin: 2px 0 0 0;
            font-size: 0.8em;
            color: #606770;
        }

        .admin-sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .admin-sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: #333;
            font-size: 0.9em;
            font-weight: 500;
            border-left: 3px solid transparent;
            transition: background-color 0.2s ease, border-left-color 0.2s ease, color 0.2s ease;
        }
        .admin-sidebar nav ul li a svg {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            fill: #606770;
            transition: fill 0.2s ease;
        }
        .admin-sidebar nav ul li a:hover,
        .admin-sidebar nav ul li a.active {
            background-color: #f0f2f5; 
            color: #1877f2; 
            border-left-color: #1877f2;
        }
        .admin-sidebar nav ul li a.active svg,
        .admin-sidebar nav ul li a:hover svg {
            fill: #1877f2;
        }
        .admin-sidebar .sidebar-footer {
            margin-top: auto; 
            padding: 15px 20px;
            border-top: 1px solid #e9ebee;
        }
        .admin-sidebar .sidebar-footer a {
            color: #d9534f !important; 
        }
        .admin-sidebar .sidebar-footer a svg {
            fill: #d9534f !important;
        }
         .admin-sidebar .sidebar-footer a:hover {
            background-color: #fdeeee; 
            color: #c9302c !important;
        }
        .admin-sidebar .sidebar-footer a:hover svg {
            fill: #c9302c !important;
        }


        .admin-main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: #f0f2f5; 
        }
        .admin-main-content h2 {
            margin-top: 0;
            font-size: 1.6em;
            color: #1c1e21;
            margin-bottom: 20px;
        }
        .admin-section-content { /* Para controlar a visibilidade das secções */
            display: none;
        }
        .admin-section-content.active {
            display: block;
        }

        .admin-card { 
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .admin-card h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: #050505;
            border-bottom: 1px solid #e9ebee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .admin-card p {
            font-size: 0.9em;
            line-height: 1.5;
        }
        .admin-card table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .admin-card th, .admin-card td {
            text-align: left;
            padding: 10px 8px;
            border-bottom: 1px solid #e9ebee;
        }
        .admin-card th {
            font-weight: 600;
            background-color: #f9f9f9;
        }
        .admin-card .action-buttons button, .admin-card .action-buttons a {
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: none;
            margin-right: 5px;
            margin-bottom: 5px; 
        }
         .admin-card .action-buttons button.edit { background-color: #f0ad4e;}
         .admin-card .action-buttons button.delete { background-color: #d9534f;}
         .admin-card .action-buttons button.ban { background-color: #777;} 
         .admin-card .action-buttons button:hover { filter: brightness(0.9); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; font-weight: 600; font-size: 0.85em;
            color: #333; margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="datetime-local"],
        .form-group textarea,
        .form-group select { 
            width: 100%; padding: 9px; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 0.9em;
        }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .form-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .form-actions button {
            padding: 9px 16px; border: none; border-radius: 6px;
            font-weight: 500; cursor: pointer; font-size: 0.9em;
        }
        .form-actions button.primary { background-color: #1877f2; color: white; }
        .form-actions button.secondary { background-color: #e4e6eb; color: #050505; }


        /* Responsividade */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 60px; 
                overflow: hidden; 
            }
            .admin-sidebar .sidebar-header h3,
            .admin-sidebar .sidebar-header p,
            .admin-sidebar nav ul li a span { 
                display: none;
            }
            .admin-sidebar nav ul li a {
                justify-content: center; 
                padding: 15px 0;
            }
            .admin-sidebar nav ul li a svg {
                margin-right: 0;
                width: 22px;
                height: 22px;
            }
             .admin-sidebar .sidebar-footer a span{
                display:none;
            }
            .admin-main-content {
                padding: 15px;
            }
            .admin-main-content h2 {
                font-size: 1.4em;
            }
            .admin-card .action-buttons button, .admin-card .action-buttons a {
                display: inline-block; 
            }
        }
        @media (max-width: 480px) {
             .admin-header .logo-area a {
                font-size: 1.2em;
            }
            .admin-header .user-actions a {
                font-size: 0.8em;
                margin-left: 10px;
            }
             .admin-header .user-actions svg {
                width: 16px;
                height: 16px;
            }
        }

    </style>
</head>
<body>

    <header class="admin-header">
        <div class="logo-area">
            <a href="./admin_panel.html">Painel do Admin - Igreja Conectada</a>
        </div>
        <div class="user-actions">
            <a href="#" id="adminUserNameDisplay">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                Admin
            </a>
            <a href="#" id="adminLogoutBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 17v-3H9v-4h7V7l5 5-5 5zM14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"/></svg>
                Sair
            </a>
        </div>
    </header>

    <div class="admin-body-container">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="https://placehold.co/60x60/1877F2/FFFFFF?text=A" alt="Avatar do administrador" id="adminSidebarAvatar" aria-label="Avatar do administrador" role="img">
                <h3 id="adminSidebarName">Admin Igreja</h3>
                <p id="adminSidebarRole">Administrador</p>
            </div>
            <nav>
                <ul>
                    <li>
                        <a href="#" class="active" data-section="overview">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm5 15h-2v-6H9v6H7v-7.81l5-4.5 5 4.5V18z"/></svg>
                            <span>Visão Geral</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="users">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                            <span>Gerir Utilizadores</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="notices">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                            <span>Gerir Avisos</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="events">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
                            <span>Gerir Eventos</span>
                        </a>
                    </li>
                     <li>
                        <a href="#" data-section="donations"> 
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-2h2v2zm0-4h-2V7h2v6zm4 4h-2v-2h2v2zm0-4h-2V7h2v6z" opacity=".3"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 7h2v6h-2V7zm0 8h2v2h-2v-2z"/></svg> 
                            <span>Gerir Doações</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="content">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2zM4 19V8h16v11H4z"/></svg>
                            <span>Gerir Conteúdo</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.44 2.67 14.2 2.5 13.96 2.5h-4c-.25 0-.48.17-.54.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c.04.32.07.65.07.98s-.03.66-.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.06.25.29.42.54.42h4c.25 0 .48-.17.54-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                            <span>Configurações</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                 <a href="#" id="adminPanelLogoutButton" class="link-item">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 17v-3H9v-4h7V7l5 5-5 5zM14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"/></svg>
                    <span>Sair do Painel</span>
                </a>
            </div>
        </aside>

        <main class="admin-main-content" id="adminMainContentArea">
            <div id="overview-section-content" class="admin-section-content active">
                <h2>Visão Geral do Administrador</h2>
                <div class="admin-card">
                    <h3>Estatísticas Rápidas (Exemplo)</h3>
                    <p>Total de Utilizadores Registados: <strong id="statsTotalUsers">...</strong></p>
                    <p>Novos Registos (últimos 7 dias): <strong id="statsNewUsers">...</strong></p>
                    <p>Avisos Publicados: <strong id="statsNoticesPublished">...</strong></p>
                    <p>Eventos Agendados: <strong id="statsEventsScheduled">...</strong></p>
                </div>
                 <div class="admin-card">
                    <h3>Ações Rápidas</h3>
                    <p style="display:flex; gap:10px; flex-wrap: wrap;">
                        <button class="action-buttons" style="background-color:#5cb85c" onclick="showAdminSection('notices'); document.getElementById('adminAddNoticeForm').scrollIntoView();">Criar Novo Aviso</button>
                        <button class="action-buttons" style="background-color:#5bc0de" onclick="showAdminSection('events');">Agendar Novo Evento</button>
                        <button class="action-buttons" style="background-color:#0275d8" onclick="showAdminSection('users');">Adicionar Utilizador</button>
                    </p>
                </div>
            </div>

            <div id="users-section-content" class="admin-section-content" style="display:none;">
                <h2>Gerir Utilizadores</h2>
                <div class="admin-card">
                    <h3>Lista de Utilizadores</h3>
                    <table id="usersTable">
                        <thead><tr><th>Nome</th><th>Email</th><th>Cargo</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody id="usersTableBody"><tr><td colspan="5" style="text-align:center;">Carregando...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="notices-section-content" class="admin-section-content" style="display:none;">
                <h2>Gerir Avisos</h2>
                <div class="admin-card">
                    <h3>Criar/Editar Aviso</h3>
                    <form id="adminAddNoticeForm">
                        <input type="hidden" id="adminNoticeId"> 
                        <div class="form-group">
                            <label for="adminNoticeTitle">Título do Aviso</label>
                            <input type="text" id="adminNoticeTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="adminNoticeContent">Conteúdo do Aviso</label>
                            <textarea id="adminNoticeContent" rows="5" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="adminNoticeCategory">Categoria (Opcional)</label>
                            <input type="text" id="adminNoticeCategory" placeholder="Ex: Geral, Urgente, Jovens">
                        </div>
                        <div class="form-group">
                            <label for="adminNoticeExpiresAt">Expira em (Opcional)</label>
                            <input type="datetime-local" id="adminNoticeExpiresAt">
                        </div>
                        <div class="form-actions" style="justify-content: flex-start;">
                            <button type="submit" class="primary">Guardar Aviso</button>
                            <button type="button" class="secondary" id="cancelEditNoticeBtn" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h3>Avisos Publicados</h3>
                    <table id="noticesTable">
                        <thead><tr><th>Título</th><th>Categoria</th><th>Expira em</th><th>Criado em</th><th>Ações</th></tr></thead>
                        <tbody id="noticesTableBody"><tr><td colspan="5" style="text-align:center;">Carregando avisos...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="events-section-content" class="admin-section-content" style="display:none;">
                <h2>Gerir Eventos</h2>
                <div class="admin-card"><p>Funcionalidade de gestão de eventos a ser implementada (similar à de Avisos).</p></div>
            </div>
            
            <div id="donations-section-content" class="admin-section-content" style="display:none;">
                <h2>Gerir Doações</h2>
                <div class="admin-card">
                    <h3>Adicionar Nova Doação</h3>
                    <form id="adminAddDonationForm">
                        <div class="form-group">
                            <label for="adminDonorName">Nome do Doador (ou "Anónimo")</label>
                            <input type="text" id="adminDonorName" placeholder="Nome ou Anónimo">
                        </div>
                        <div class="form-group">
                            <label for="adminDonationAmount">Valor (R$)</label>
                            <input type="number" id="adminDonationAmount" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="adminDonationDate">Data da Doação</label>
                            <input type="date" id="adminDonationDate" required>
                        </div>
                        <div class="form-group">
                            <label for="adminDonationCampaign">Campanha/Destino (Opcional)</label>
                            <input type="text" id="adminDonationCampaign" placeholder="Ex: Construindo o Futuro">
                        </div>
                        <div class="form-group">
                            <label for="adminDonationNotes">Observações (Opcional)</label>
                            <textarea id="adminDonationNotes" rows="2"></textarea>
                        </div>
                        <div class="form-actions" style="justify-content: flex-start;">
                            <button type="submit" class="primary">Adicionar Doação</button>
                        </div>
                    </form>
                </div>

                <div class="admin-card">
                    <h3>Lista de Doações Registadas</h3>
                    <table id="donationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Doador</th>
                                <th>Valor (R$)</th>
                                <th>Data</th>
                                <th>Campanha</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="donationsTableBody">
                            <tr><td colspan="6" style="text-align:center;">Carregando doações...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-section-content" class="admin-section-content" style="display:none;">
                <h2>Gerir Conteúdo</h2>
                <div class="admin-card"><p>Funcionalidade de gestão de conteúdo (ex: sermões, estudos) a ser implementada.</p></div>
            </div>
            <div id="settings-section-content" class="admin-section-content" style="display:none;">
                <h2>Configurações</h2>
                <div class="admin-card"><p>Funcionalidade de configurações gerais da aplicação a ser implementada.</p></div>
            </div>
        </main>
    </div>

    <script>
        // Removido SUPABASE_URL e SUPABASE_ANON_KEY duplicados
        // let supabaseClient = null;
        const supabaseClient = initSupabase();

        if (!supabaseClient) {
            NotificationSystem.error('Erro de configuração do Supabase.');
        }

        const adminUserNameDisplay = document.getElementById('adminUserNameDisplay');
        const adminSidebarAvatar = document.getElementById('adminSidebarAvatar');
        const adminSidebarName = document.getElementById('adminSidebarName');
        const adminSidebarRole = document.getElementById('adminSidebarRole');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminPanelLogoutButton = document.getElementById('adminPanelLogoutButton');

        async function checkAdminSessionAndSetup() {
            if (!supabaseClient) {
                alert("Erro de conexão com o servidor.");
                window.location.href = './login.html'; 
                return;
            }
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session && session.user) {
                // Integração REST Supabase: buscar full_name do usuário logado
                try {
                    const url = `https://bilhtpgelctnybjemzeg.supabase.co/rest/v1/profiles?select=full_name&id=eq.${session.user.id}`;
                    const response = await fetch(url, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.ANON_KEY,
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    });
                    const restData = await response.json();
                    if (restData && restData.length > 0) {
                        console.log('REST full_name:', restData[0].full_name);
                    }
                } catch (err) {
                    console.error('Erro na requisição REST do Supabase:', err);
                }

                const user = session.user;
                console.log("Admin (ou utilizador) logado:", user.email);
                // TODO: Implementar verificação de role de administrador aqui.
                if(adminUserNameDisplay) adminUserNameDisplay.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg> ${user.email}`;
                if(adminSidebarName) adminSidebarName.textContent = user.email;
                if(adminSidebarRole) adminSidebarRole.textContent = "Administrador"; 
                
                showAdminSection('overview'); // Carregar secção inicial
            } else {
                window.location.href = './login.html'; 
            }
        }

        async function handleLogout() {
            if (!supabaseClient) return;
            const { error } = await supabaseClient.auth.signOut();
            window.location.href = './index.html';
        }
        if (adminLogoutBtn) adminLogoutBtn.addEventListener('click', handleLogout);
        if (adminPanelLogoutButton) adminPanelLogoutButton.addEventListener('click', handleLogout);

        function showAdminSection(sectionName) { // Renomeada para evitar conflito com showPage da SPA
            document.querySelectorAll('.admin-section-content').forEach(sec => sec.style.display = 'none');
            const activeSection = document.getElementById(`${sectionName}-section-content`);
            if (activeSection) {
                activeSection.style.display = 'block';
                console.log(`Carregando conteúdo para: ${sectionName}`);
                if (sectionName === 'overview') loadAdminOverviewData();
                if (sectionName === 'users') loadAdminUsersTable();
                if (sectionName === 'notices') loadAdminNoticesTable(); 
                if (sectionName === 'donations') loadAdminDonationsTable(); 
                // Atualizar classe 'active' no menu admin
                document.querySelectorAll('.admin-sidebar nav ul li a').forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('data-section') === sectionName) {
                        link.classList.add('active');
                    }
                });
            } else {
                console.warn(`Secção de conteúdo "${sectionName}-section-content" não encontrada.`);
            }
        }
        
        async function loadAdminOverviewData(){ 
            if(!supabaseClient) return;
            const { count: totalUsers, error: totalUsersError } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true });
            if(totalUsersError) console.error("Erro ao buscar total de usuários:", totalUsersError);
            else if(document.getElementById('statsTotalUsers')) document.getElementById('statsTotalUsers').textContent = totalUsers || 0;
            if(document.getElementById('statsNewUsers')) document.getElementById('statsNewUsers').textContent = "0"; 
            if(document.getElementById('statsNoticesPublished')) document.getElementById('statsNoticesPublished').textContent = "0"; 
            if(document.getElementById('statsEventsScheduled')) document.getElementById('statsEventsScheduled').textContent = "0"; 
        }
        async function loadAdminUsersTable() { /* ... (código da versão anterior) ... */ }
        function adminEditUser(userId) { alert(`Editar utilizador: ${userId} (Funcionalidade a implementar)`); }
        async function adminBanUser(userId, shouldBan) { /* ... (código da versão anterior) ... */ }
        async function adminDeleteUser(userId) { /* ... (código da versão anterior) ... */ }

        // --- Funções para Gerir Avisos ---
        const adminAddNoticeForm = document.getElementById('adminAddNoticeForm');
        const cancelEditNoticeBtn = document.getElementById('cancelEditNoticeBtn');
        let editingNoticeId = null; 

        if (adminAddNoticeForm) {
            adminAddNoticeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!supabaseClient) { NotificationSystem.error('Cliente Supabase não inicializado.'); return; }
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) { NotificationSystem.error('Sessão de admin inválida.'); return; }

                const title = document.getElementById('adminNoticeTitle').value.trim();
                const content = document.getElementById('adminNoticeContent').value.trim();
                const category = document.getElementById('adminNoticeCategory').value.trim() || null;
                const expires_at_val = document.getElementById('adminNoticeExpiresAt').value;
                const expires_at = expires_at_val ? new Date(expires_at_val).toISOString() : null;

                if (!title || !content) {
                    NotificationSystem.error('Título e Conteúdo do aviso são obrigatórios.');
                    return;
                }
                const noticeData = { title, content, category, expires_at, user_id: user.id };
                let response;
                if (editingNoticeId) { 
                    response = await supabaseClient.from('notices').update(noticeData).eq('id', editingNoticeId).select();
                } else { 
                    response = await supabaseClient.from('notices').insert([noticeData]).select();
                }
                if (response.error) {
                    NotificationSystem.error('Erro ao guardar aviso: ' + response.error.message);
                } else {
                    NotificationSystem.success(`Aviso ${editingNoticeId ? 'atualizado' : 'criado'} com sucesso!`);
                    adminAddNoticeForm.reset();
                    editingNoticeId = null; 
                    if(cancelEditNoticeBtn) cancelEditNoticeBtn.style.display = 'none';
                    document.querySelector('#notices-section-content h3').textContent = 'Criar Novo Aviso';
                    loadAdminNoticesTable();
                }
            });
        }
        
        if(cancelEditNoticeBtn){
            cancelEditNoticeBtn.addEventListener('click', () => {
                adminAddNoticeForm.reset();
                editingNoticeId = null;
                cancelEditNoticeBtn.style.display = 'none';
                document.querySelector('#notices-section-content h3').textContent = 'Criar Novo Aviso';
            });
        }

        async function loadAdminNoticesTable() {
            const noticesTableBody = document.getElementById('noticesTableBody');
            if (!noticesTableBody || !supabaseClient) return;
            noticesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Carregando avisos...</td></tr>';

            const { data: notices, error } = await supabaseClient
                .from('notices')
                .select('id, title, category, created_at, expires_at, content') 
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Erro ao carregar avisos:", error);
                noticesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">Erro ao carregar avisos.</td></tr>';
                return;
            }

            if (notices && notices.length > 0) {
                noticesTableBody.innerHTML = '';
                notices.forEach(n => {
                    const row = noticesTableBody.insertRow();
                    row.insertCell().textContent = n.title;
                    row.insertCell().textContent = n.category || '-';
                    row.insertCell().textContent = n.expires_at ? new Date(n.expires_at).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) : 'Permanente';
                    row.insertCell().textContent = new Date(n.created_at).toLocaleDateString('pt-BR');
                    row.insertCell().innerHTML = `
                        <div class="action-buttons">
                            <button class="edit" onclick="adminEditNotice(${n.id}, '${n.title.replace(/'/g, "\\'")}', '${n.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${n.category || ''}', '${n.expires_at || ''}')">Editar</button>
                            <button class="delete" onclick="adminDeleteNotice(${n.id})">Excluir</button>
                        </div>`;
                });
            } else {
                noticesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum aviso encontrado.</td></tr>';
            }
        }

        function adminEditNotice(id, title, content, category, expires_at) {
            document.getElementById('adminNoticeId').value = id;
            document.getElementById('adminNoticeTitle').value = title;
            document.getElementById('adminNoticeContent').value = content.replace(/\\n/g, "\n");
            document.getElementById('adminNoticeCategory').value = category;
            document.getElementById('adminNoticeExpiresAt').value = expires_at ? new Date(expires_at).toISOString().slice(0,16) : '';
            
            editingNoticeId = id;
            if(cancelEditNoticeBtn) cancelEditNoticeBtn.style.display = 'inline-block';
            document.querySelector('#notices-section-content h3').textContent = 'Editar Aviso';
            adminAddNoticeForm.scrollIntoView({ behavior: 'smooth' });
        }

        async function adminDeleteNotice(noticeId) {
            if (!supabaseClient) return;
            if (confirm(`Tem certeza que deseja excluir o aviso ID: ${noticeId}?`)) {
                const { error } = await supabaseClient.from('notices').delete().eq('id', noticeId);
                if (error) { NotificationSystem.error('Erro ao excluir aviso: ' + error.message); }
                else { NotificationSystem.success('Aviso excluído com sucesso!'); loadAdminNoticesTable(); }
            }
        }

        // Funções para Gerir Doações
        const adminAddDonationForm = document.getElementById('adminAddDonationForm');
        if (adminAddDonationForm) { /* ... (código da versão anterior) ... */ }
        async function loadAdminDonationsTable() { /* ... (código da versão anterior) ... */ }
        function adminEditDonation(donationId) { /* ... (código da versão anterior) ... */ }
        async function adminDeleteDonation(donationId) { /* ... (código da versão anterior) ... */ }


        document.addEventListener('DOMContentLoaded', () => {
            checkAdminSessionAndSetup();
            
            document.querySelectorAll('.admin-sidebar nav ul li a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.admin-sidebar nav ul li a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const section = link.getAttribute('data-section');
                    showAdminSection(section); // Usar a função renomeada
                });
            });
        });
    </script>
</body>
</html>
